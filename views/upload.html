<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  
  <link rel="stylesheet" href="/css/index.css">
  
  <!-- FontAwesome icons -->
  <script src="https://kit.fontawesome.com/17d86c0acc.js" crossorigin="anonymous"></script>
  <title>Upload | PAC, Inc - Salug Campus</title>
</head>
<body class="uploadBody">
  <div class="container">
    <div class="header">
      <div class="schoolHeader">
        <img src="/images/paclogo.png" alt="logo">
        <div class="lgTitle">
          <h2>Philippine Advent College, Inc. - Salug Campus</h2>
          <p>E-Learning Materials</p>
        </div>
        <div class="smTitle">
          <h2>PAC, Inc. - Salug Campus</h2>
          <p>E-Learning Materials</p>
        </div>
      </div>
      <div class="user menuBtn">
        <i class="fa-solid fa-burger"></i>
      </div>
      <div class="lgUser userImg">
        <div class="lgUserInfo">
          <div class="infos">
            <div class="profile">
              <div class="userImg"></div>
              <div class="info">
                <p class="userName"></p>
                <span class="studentCourse"></span>
              </div>
            </div>
            <button class="">
              <i class="fa-brands fa-xing lgCloseMenu"></i>
            </button>
          </div>
          <div class="logoutBox">
            <div class="logout">
              <button class="logoutBtn">Logout</button>
            </div>
            <div class="credits">
              <p>Developed by: Renz (⁠ ⁠ꈍ⁠ᴗ⁠ꈍ⁠)⁠◜⁠✧</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="navigation">
      <div class="navbar">
        <div class="userInfo">
          <div class="profile">
            <div class="userImg"></div>
            <div class="info">
              <p class="userName"></p>
              <span class="studentCourse"></span>
            </div>
          </div>
          <button class="closeMenu">
            <i class="fa-brands fa-xing"></i>
          </button>
        </div>
        <div class="links">
          <a href="/">
            <li>
              <i class="fa-solid fa-home"></i>
              <p>Home</p>
            </li>
          </a>
          <a href="/files/upload">
            <li>
              <i class="fa-solid fa-upload"></i>
              <p>Upload Files</p>
            </li>
          </a>
        </div>
        <div class="navbarFooter">
          <div class="logout">
            <button class="logoutBtn">Logout</button>
          </div>
          <div class="credits">
            <p>Developed by: Renz (⁠ ⁠ꈍ⁠ᴗ⁠ꈍ⁠)⁠◜⁠✧</p>
          </div>
        </div>
      </div>
    </div>
    <div class="contents">
      <div class="uploadContainer">
        <form class="uploadForm">
          <h3>Upload files</h3>
          <div class="uploadInputs">
            <label>
              Filename (single/optional):
              <input class="fileName" type="text" />
            </label>
            <label>
              File thumbnail (single/image/optional):
              <input class="thumbnail" type="file"/>
            </label>
            <div class="uploadType">
              <p>Upload type:</p>
              <div class="types">
                <label>
                  <input type="radio" value="single" checked="true"/>
                  Single
                </label>
                <label>
                  <input type="radio" value="multiple"/>
                  Multiple
                </label>
              </div>
            </div>
            <label>
              Category:
              <select class="category">
                <option value="" disabled selected>Select category...</option>
              </select>
              <p class="categoryError"></p>
            </label>
            <label>
              Department:
              <select class="department">
                <option value="" disabled selected>Select department...</option>
              </select>
              <p class="departmentError"></p>
            </label>
            <label>
              Files (select atleast 1 file):
              <input class="files" type="file"/>
              <p class="filesError"></p>
            </label>
          </div>
          <button class="uploadBtn" type="submit">Upload</button>
        </form>
        <div class="results">
          <div class="head">
            <p>Filename</p>
            <p>Status</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/script/index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.5/axios.min.js"></script>
  <script>
    const uploadTypes = document.querySelectorAll('input[type="radio"]');
    const fileName = document.querySelector('.fileName');
    const thumbnail = document.querySelector('.thumbnail');
    const category = document.querySelector('.category');
    const department = document.querySelector('.department');
    const files = document.querySelector('.files');
    const results = document.querySelector('.results');
    
    for (uploadType of uploadTypes){
      uploadType.onclick = (event) => {
        for (typeValue of uploadTypes){
          if (event.target.value == typeValue.value) continue;
          typeValue.value == 'multiple' ? (fileName.disabled = false, thumbnail.disabled = false, files.multiple = false) : 
            (fileName.disabled = true, thumbnail.disabled = true, files.multiple = true);
          typeValue.checked = false;
        }
      }
    }
    
    const validateInputs = () => {
      let status = false;
      let single = false;
      for (type of uploadTypes) {
        if (type.value == 'single' && type.checked) single = true;
      }
      category.value.trim() === '' ?
        (status = true, document.querySelector('.categoryError').textContent = 'Category is required.') :
        document.querySelector('.categoryError').textContent = '';
      department.value.trim() === '' ?
        (status = true, document.querySelector('.departmentError').textContent = 'Department is required.') :
        document.querySelector('.departmentError').textContent = '';
      files.files.length < 1 ?
        (status = true, document.querySelector('.filesError').textContent = 'Files must be from 1 to 10 only.') :
        files.files.length > 10 ?
          (status = true, document.querySelector('.filesError').textContent = 'Files must be from 1 to 10 only.') :
          files.files.length > 1 && single ?
            (status = true, document.querySelector('.filesError').textContent = 'You selected single upload type.') :
            document.querySelector('.filesError').textContent = '';
      return status;
    }
    
    document.querySelector('.uploadForm').onsubmit = async (event) => {
      event.preventDefault();
      document.querySelector('.uploadForm').onchange = () => validateInputs();
      
      if (validateInputs()) return;
      
      document.querySelector('.uploadBtn').textContent = 'Uploading...';
      document.querySelector('.uploadBtn').disabled = true;
      
      const formData = new FormData();
      
      formData.append('category', category.value);
      formData.append('department', department.value);
      
      let single = false;
      for (type of uploadTypes) {
        if (type.value == 'single' && type.checked) single = true;
      }
      
      if (single) formData.append('filename', fileName.value);
      if (thumbnail.files.length > 0 && single) formData.append('thumbnail', thumbnail.files[0]);
      if (files.files.length > 0) {
        for (file of files.files) {
          formData.append('files', file);
        }
      }
      
      try{
        const {data} = await axios.post('/files/upload', formData);
        for (d of data) {
          results.innerHTML += `
            <div class="file">
              <p>${d.filename}</p>
              <p style="color:${d.error ? 'red">failed' : 'green">success'}</p>
            </div>`;
        }
        results.style.visibility = 'visible';
        document.querySelector('.uploadBtn').textContent = 'Upload';
        document.querySelector('.uploadBtn').disabled = false;
      } catch (e) {
        alert(e.message);
        document.querySelector('.uploadBtn').textContent = 'Upload';
        document.querySelector('.uploadBtn').disabled = false;
      }
    }
  </script>
</body>
</html>